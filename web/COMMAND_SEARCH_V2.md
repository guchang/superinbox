# 命令搜索功能说明 V2

## 功能概述

全新的多条件组合搜索体验，支持流畅的筛选条件堆叠和搜索历史记录。

## 快速开始

### 快捷键
- **⌘K** (Mac) 或 **Ctrl+K** (Windows/Linux): 打开/关闭搜索对话框

## 核心交互流程

### 1. 初始状态（唤起搜索框）
```
┌─────────────────────────────────┐
│ 🔍 搜索选项或输入关键字...       │
├─────────────────────────────────┤
│ 🕐 最近搜索                     │
│   • [待办事项] [已完成]         │
│   • [开会]                      │
│   • [失败]                      │
├─────────────────────────────────┤
│ 添加筛选条件                    │
│   • 意图                        │
│   • 状态                        │
│   • 来源                        │
└─────────────────────────────────┘
```

### 2. 选择筛选选项
点击或使用键盘选择"意图"后：

```
┌─────────────────────────────────┐
│ 🔍 意图:          [✕]          │
├─────────────────────────────────┤
│ 选择意图                        │
│   • 待办事项                    │
│   • 想法                        │
│   • 支出                        │
│   • 笔记                        │
│   • 书签                        │
│   • 日程                        │
└─────────────────────────────────┘
```

### 3. 应用筛选条件
选择"待办事项"后，搜索框保持打开，返回主视图：

```
┌─────────────────────────────────┐
│ 🔍 搜索选项或输入关键字...       │
├─────────────────────────────────┤
│ 已应用的筛选                    │
│   清除所有筛选 (清除 1)          │
│   意图: 待办事项        [✕]     │
├─────────────────────────────────┤
│ 添加筛选条件                    │
│   • 意图 (已应用)               │
│   • 状态                        │
│   • 来源                        │
└─────────────────────────────────┘
```

### 4. 继续添加筛选
继续选择"状态" → "已完成"：

```
┌─────────────────────────────────┐
│ 🔍 搜索选项或输入关键字...       │
├─────────────────────────────────┤
│ 已应用的筛选                    │
│   清除所有筛选 (清除 2)          │
│   意图: 待办事项        [✕]     │
│   状态: 已完成          [✕]     │
├─────────────────────────────────┤
│ 添加筛选条件                    │
│   • 意图 (已应用)               │
│   • 状态 (已应用)               │
│   • 来源                        │
└─────────────────────────────────┘
```

### 5. 最终搜索框显示
关闭搜索框后，搜索框显示：

```
┌─────────────────────────────────┐
│ 🔍 待办事项 · 已完成      [2]   │
└─────────────────────────────────┘
```

## 交互特性

### ✨ 核心体验
1. **不关闭对话框**：选择筛选条件后，搜索框保持打开状态，方便继续添加其他条件
2. **清晰的视觉反馈**：已应用的筛选条件显示"已应用"徽章
3. **快速取消**：激活选项后，点击 ✕ 按钮快速返回主视图
4. **实时预览**：搜索框顶部始终显示当前已应用的所有筛选条件

### 🎯 键盘操作
- **↑↓**：在选项之间导航
- **Enter**：选择当前高亮的选项
- **Esc**：取消当前操作 / 关闭搜索框
- **Backspace**：在空输入时返回上一级

### 📱 搜索历史
- 自动记录最近 5 次搜索
- 点击历史记录可快速应用一组筛选条件
- 显示为可点击的徽章组合

## 多条件组合示例

### 示例 1：查找未完成的待办任务
1. 按 ⌘K 打开搜索
2. 选择"意图" → "待办事项"
3. 继续选择"状态" → "待处理"
4. 搜索框显示：`待办事项 · 待处理`

### 示例 2：搜索特定来源的失败记录
1. 按 ⌘K 打开搜索
2. 选择"状态" → "失败"
3. 继续选择"来源" → "cli"
4. 搜索框显示：`失败 · cli`

### 示例 3：组合全文搜索和筛选
1. 按 ⌘K 打开搜索
2. 输入"会议" → 选择"搜索 '会议'"
3. 继续选择"意图" → "日程"
4. 搜索框显示：`会议 · 日程`

## 技术实现

### 状态管理
```typescript
interface SearchFilters {
  query: string          // 全文搜索
  intent?: IntentType    // 意图筛选
  status?: ItemStatus    // 状态筛选
  source?: string        // 来源筛选
}
```

### 组件状态
- `open`: 对话框开关状态
- `inputValue`: 当前输入值
- `activeOption`: 当前激活的筛选选项（intent/status/source）
- `searchHistory`: 搜索历史记录

### 搜索历史格式
```typescript
type SearchHistoryItem = AppliedFilter[]

interface AppliedFilter {
  type: 'intent' | 'status' | 'source' | 'query'
  value: string
  display: string
}
```

## 文件结构

### 前端
- `/web/src/components/ui/command.tsx` - Command 组件基础（添加了 CommandSeparator）
- `/web/src/components/shared/command-search.tsx` - 搜索和筛选组件（完全重写）

### 后端
- `/backend/src/capture/controllers/inbox.controller.ts` - API 控制器（支持 query 参数）
- `/backend/src/storage/database.ts` - 数据库查询（LIKE 全文搜索）
- `/backend/src/types/index.ts` - QueryFilter 类型定义

## 用户体验优化

### V1 vs V2

| 特性 | V1 | V2 |
|------|----|----|
| 选择筛选后 | 关闭对话框 | 保持打开 |
| 多条件组合 | 需要重新打开 | 流畅连续 |
| 搜索历史 | ❌ | ✅ |
| 已筛选状态指示 | 部分显示 | 清晰显示 |
| 取消操作 | 重新打开 | ✕ 按钮快速取消 |
| 视觉层次 | 平铺 | 分组（历史/已应用/可添加） |

### 关键改进
1. **减少点击次数**：多条件筛选不需要反复打开对话框
2. **上下文保持**：始终能看到当前已应用的筛选条件
3. **快速纠错**：单个筛选条件可以独立移除
4. **历史复用**：常用的筛选组合可以一键应用

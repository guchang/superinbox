# 🛑 AI 协作重要说明

**对 AI Agent 的紧急提示：** 在开始任何工作前，**必须阅读**此文件！

---

## 🔴 后端代码修改保护

### **绝对禁止（未经授权）**

以下操作**绝对禁止**在未经用户明确授权的情况下执行：

❌ 修改 `backend/src/` 下的任何文件
❌ 修改 `backend/package.json`
❌ 修改数据库迁移文件（`backend/src/storage/migrations/`）
❌ 修改 API 路由或控制器
❌ 修改适配器实现

### ✅ 允许的操作

以下操作可以**自主执行**（无需授权）：

✅ 读取 `backend/` 目录代码进行分析
✅ 运行后端测试命令（`npm test` 等）
✅ 查看后端日志
✅ **修改前端代码：** `web/`, `cli/`, `docs/` 目录
✅ 回答关于后端代码的问题

---

## 📋 修改后端代码的标准流程

如果任务**确实需要**修改后端代码，**必须**遵循以下流程：

### 步骤 1：说明必要性

向用户清楚解释：
- 为什么需要修改后端
- 计划修改哪些文件
- 具体修改内容
- 可能的影响和风险

### 步骤 2：请求授权

使用以下格式**明确请求**用户授权：

```markdown
## 🔔 后端修改请求

**目标：** [简短描述]

**需要修改：**
- 文件：`backend/src/xxx/yyy.ts`
- 行数：123-145
- 变更类型：[新增/修改/删除]

**修改原因：**
[详细说明为什么必须修改后端]

**影响分析：**
- 影响模块：[列出可能受影响的模块]
- 风险等级：低/中/高
- 回滚方案：[如果出问题如何恢复]

**代码预览：**
```typescript
// 修改前的代码
...
// 修改后的代码
...
```

**需要您的确认：**
请回复 "同意" 或 "可以执行" 授权此修改。
```

### 步骤 3：等待用户明确授权

**必须等待**以下任一回复：
- ✅ "同意"
- ✅ "可以执行"
- ✅ "批准"
- ✅ "OK"

如果用户回复：
- ❌ "不允许" - 停止后端修改，寻找替代方案
- ❌ "只改前端" - 评估是否可以仅通过前端实现
- ❌ "换个方案" - 提供替代技术方案

### 步骤 4：执行并报告

获得授权后：
1. 执行后端修改
2. 运行测试验证
3. 向用户报告："✅ 后端修改已完成，请审查"

---

## 🚨 紧急情况处理

如果发现**严重的安全漏洞**或**阻塞性 bug**：

### 判断标准

**紧急程度 - 高**（可立即修复）：
- 生产环境安全漏洞（SQL注入、XSS、认证绕过）
- 数据丢失风险
- 服务完全不可用

**紧急程度 - 中**（需要快速讨论）：
- 非critical 但重要的 bug
- 性能严重下降
- 功能异常但可用临时方案

**紧急程度 - 低**（正常流程）：
- 新功能开发
- 代码重构
- 优化改进

### 紧急处理流程

```markdown
## 🚨 紧急后端修改请求

**严重程度：** 高 / 中 / 低

**问题发现：**
[描述发现的问题]

**影响范围：**
- 用户影响：[是否影响用户使用]
- 数据影响：[是否涉及数据安全]
- 服务影响：[是否影响服务可用性]

**临时方案：**
[是否有临时缓解措施]

**建议修改：**
- 修改文件：`backend/src/xxx/yyy.ts`
- 修改内容：[简要说明]
- 预计时间：[预计需要多长时间]

**需要紧急处理？** 是 / 否
```

---

## 💡 最佳实践

### 1. 优先前端方案

在发现需要修改后端时，**首先评估**是否可以通过前端实现：

**示例：**
```
用户请求：添加日志筛选功能

AI 分析：
方案 A（后端）：修改后端 API，支持更多筛选参数
方案 B（前端）：在客户端筛选已获取的数据

推荐：方案 B - 前端筛选
原因：无需修改后端，风险低，实现快
```

### 2. 分阶段实施

如果必须修改后端，考虑分阶段：

**Phase 1：** 先实现前端部分（无需后端修改）
**Phase 2：** 后端改进（单独分支，充分测试）
**Phase 3：** 集成和部署

### 3. 测试要求

任何后端修改后**必须**：
- ✅ 运行单元测试
- ✅ 运行集成测试
- ✅ 手动测试受影响的功能
- ✅ 向用户报告测试结果

---

## 📝 示例对话

### ❌ 错误示例（未经授权修改后端）

```
用户：帮我添加日志筛选功能

AI：好的，我来修改后端 API...
[直接修改了 backend/src/...]
```
**问题：** 未经授权修改后端，违反安全策略！

---

### ✅ 正确示例（请求授权）

```
用户：帮我添加日志筛选功能

AI：我分析了需求，有两种实现方案：

**方案 A（后端修改）：**
- 修改 `backend/src/auth/controllers/logs.controller.ts`
- 添加新的筛选参数支持
- 优点：服务端筛选性能更好
- 缺点：需要修改后端代码

**方案 B（前端实现）：**
- 在客户端筛选已获取的数据
- 优点：无需修改后端，实现快速
- 缺点：大量数据时性能较差

**推荐：** 方案 B - 前端实现

如果未来确实需要后端筛选，我可以再请求您的授权。

您希望使用哪个方案？
```

---

## 🔍 检查清单

在执行任何涉及后端的操作前，**必须**自检：

- [ ] 是否必须修改后端？能否用前端实现？
- [ ] 是否已向用户说明了必要性？
- [ ] 是否已获得了用户的明确授权？
- [ ] 是否已经评估了影响和风险？
- [ ] 是否准备了回滚方案？

**如果以上任何一项为"否"，停止并请求授权！**

---

## 📌 记住

> **核心原则：** 后端是系统的核心，保护它就是保护整个系统的稳定性。宁可多花时间沟通，也不要擅自修改。

---

**文件位置：** `/Users/wudao/SuperInbox/AI_INSTRUCTIONS.md`
**版本：** 1.0.0
**最后更新：** 2026-01-17
**状态：** 🚨 有效

# 收件箱路由分发实时进度功能

## 功能概述

实现了收件箱条目路由分发的实时进度显示，通过 Server-Sent Events (SSE) 技术，用户可以实时看到条目从创建到分发完成的整个过程。

## 技术架构

### 后端实现

1. **SSE 事件类型定义** (`backend/src/types/routing-progress.ts`)
   - 定义了完整的路由进度事件类型
   - 包括开始、规则匹配、工具调用、完成等各个阶段

2. **SSE 连接管理器** (`backend/src/services/sse-manager.ts`)
   - 管理客户端 SSE 连接
   - 支持多客户端同时监听同一条目
   - 自动清理过期连接

3. **收件箱 SSE 端点** (`backend/src/capture/routes/inbox.routes.ts`)
   - `GET /v1/inbox/:id/routing-progress` - SSE 端点
   - 支持通过 URL 参数传递认证 token

4. **路由分发进度回调** (`backend/src/router/router.service.ts`)
   - 改造路由服务，支持进度回调
   - 在各个关键节点发送进度事件

5. **认证支持** (`backend/src/middleware/auth.ts`)
   - 支持通过 URL 参数传递 JWT token（用于 SSE）

### 前端实现

1. **SSE 客户端 Hook** (`web/src/hooks/use-routing-progress.ts`)
   - 管理 SSE 连接生命周期
   - 处理各种进度事件
   - 支持自动重连

2. **路由状态组件** (`web/src/components/inbox/routing-status.tsx`)
   - 动态显示路由状态
   - 支持不同状态的视觉反馈
   - 优雅的动画效果

3. **调试组件** (`web/src/components/inbox/routing-status-debug.tsx`)
   - 开发模式下的调试信息
   - 显示连接状态和详细进度

## 用户体验流程

1. **初始状态**: "路由: 待配置"
2. **开始分发**: "路由: 开始路由分发..." (蓝色，脉冲动画)
3. **匹配规则**: "路由: 匹配规则: Todoist 任务分发" (黄色，闪电图标)
4. **工具调用**: "路由: 开始调用 Todoist.create_task" (蓝色，加载动画)
5. **执行进度**: "路由: 创建任务 '买牛奶' 到 Todoist..." (蓝色，加载动画)
6. **完成单个**: "路由: ✓ 成功分发到 Todoist" (绿色，成功图标)
7. **最终结果**: "路由: 已分发到 2 个目标" (绿色，成功图标)

## 状态说明

- **pending**: 路由待配置 (灰色)
- **starting**: 开始分发 (蓝色，脉冲)
- **matching**: 匹配规则 (黄色，闪电)
- **distributing**: 分发中 (蓝色，旋转)
- **completed**: 已完成 (绿色，勾选)
- **error**: 出错 (红色，错误)

## 部署位置

- **收件箱列表页面**: 每个条目显示实时路由状态
- **收件箱详情页面**: 专门的路由状态区域 + 调试信息

## 开发调试

在开发模式下，可以：
1. 查看 SSE 连接状态指示器
2. 使用调试组件查看详细进度信息
3. 手动重连 SSE 连接
4. 查看控制台日志

## 性能优化

1. **连接管理**: 自动清理过期连接
2. **重连机制**: 指数退避重连策略
3. **事件过滤**: 只监听相关事件类型
4. **内存清理**: 组件卸载时自动断开连接

## 错误处理

1. **认证失败**: 显示认证错误信息
2. **连接断开**: 自动重连，最多 5 次
3. **解析错误**: 忽略无效事件，记录日志
4. **网络错误**: 显示连接状态，支持手动重连

## 浏览器兼容性

- 支持所有现代浏览器的 EventSource API
- 自动处理连接中断和重连
- 优雅降级：如果 SSE 不可用，显示静态状态

## 安全考虑

1. **认证**: 通过 JWT token 验证用户身份
2. **授权**: 只能监听自己的条目进度
3. **数据过滤**: 不暴露敏感的内部信息
4. **连接限制**: 自动清理过期连接，防止资源泄露
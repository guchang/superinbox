# SuperInbox 启动工具使用说明

本指南为启动工具的唯一说明文档，包含快速开始、命令速查、排障与实现附录。

## 1. 快速开始（3 分钟）

### macOS / Linux（Bash 版本）

```bash
./start.sh
```

### Windows / macOS / Linux（Node.js 版本）

```bash
node start.js
```

## 2. 一键启动支持的脚本

SuperInbox 提供两个版本的启动工具，功能一致：

1. `start.sh`：适用于 macOS/Linux/WSL
2. `start.js`：适用于 Windows/macOS/Linux（跨平台更好）

## 3. 启动后会自动完成的步骤

- 检查 Node.js 与 npm
- 询问是否安装依赖（首次运行）
- 检查端口占用（默认 3000、3001）
- 交互式处理端口冲突
- 启动后端和前端服务
- 输出访问地址并实时显示日志

## 4. 服务地址与默认端口

默认情况下：

- 前端界面：`http://localhost:3001`
- 后端 API：`http://localhost:3000/v1`

端口环境变量：

- 后端端口：`BACKEND_PORT`（默认 `3000`）
- 前端端口：`FRONTEND_PORT`（默认 `3001`）

## 5. 常用命令速查

```bash
# 启动
./start.sh
node start.js

# 查看状态
./start.sh status
node start.js status

# 停止服务
./start.sh stop
node start.js stop

# 重启服务
./start.sh restart
node start.js restart
```

状态输出示例：

```text
========== 服务状态 ==========

后端服务: 运行中 (PID: 12345, 端口: 3000)
前端服务: 运行中 (PID: 12346, 端口: 3001)

============================
```

## 6. 端口冲突处理

当检测到端口被占用时，工具会提供 3 个选项：

1. 停止占用进程并继续
2. 跳过当前服务启动
3. 退出脚本

交互示例：

```text
发现以下选项:
  1) 停止占用端口 3000 的进程并继续
  2) 跳过后端启动
  3) 退出脚本

请选择操作 [1-3]:
```

## 7. 自定义端口与环境变量

```bash
# Bash 版本
BACKEND_PORT=8080 FRONTEND_PORT=8081 ./start.sh

# Node.js 版本
BACKEND_PORT=8080 FRONTEND_PORT=8081 node start.js
```

## 8. 日志与 PID 文件

日志文件：

- `backend.log`：后端服务日志
- `frontend.log`：前端服务日志

PID 文件：

- `.backend.pid`：后端进程 ID
- `.frontend.pid`：前端进程 ID

日志查看方式：

```bash
tail -f backend.log
tail -f frontend.log
tail -f backend.log frontend.log
```

提示：启动后默认会实时展示日志，按 `Ctrl+C` 仅停止日志跟随，不会停止服务。

## 9. 故障排除

### 9.1 端口被占用无法停止

```bash
lsof -i :3000
kill -9 <PID>
```

### 9.2 依赖安装失败

```bash
cd backend && npm install
cd ../web && npm install
```

### 9.3 服务启动失败

1. 查看 `backend.log` 与 `frontend.log`
2. 检查 Node.js 版本（需 `>= 18.0.0`）
3. 检查环境变量配置
4. 检查数据库与后端依赖状态

### 9.4 前端无法连接后端

1. 执行 `./start.sh status` 确认后端在运行
2. 检查前端配置的 API 地址
3. 查看浏览器控制台和后端日志

## 10. 高级用法

### 10.1 仅启动后端

在脚本中注释前端启动调用（如 `start_frontend`）。

### 10.2 仅启动前端

在脚本中注释后端启动调用（如 `start_backend`）。

### 10.3 集成到其他脚本

```bash
#!/bin/bash

cd /path/to/SuperInbox
./start.sh
```

## 11. 系统要求与注意事项

系统要求：

- Node.js：`>= 18.0.0`
- npm：已安装
- Bash 版本额外依赖：`lsof`（通常系统自带）

注意事项：

1. 首次启动前请确认 Node.js 可用
2. 建议定期更新依赖：`npm update`
3. 生产环境建议使用构建后的启动流程
4. 不建议手动删除 PID 文件

## 12. 附录：实现机制与扩展建议

### 12.1 端口检测机制

```bash
lsof -i :<port> -sTCP:LISTEN -t
```

用于检测端口占用、获取 PID，并辅助冲突处理。

### 12.2 启动流程（简化）

```text
检查 Node.js/npm
  -> 可选安装依赖
  -> 停止旧进程
  -> 检查后端端口并处理冲突
  -> 启动后端
  -> 检查前端端口并处理冲突
  -> 启动前端
  -> 输出访问信息并跟随日志
```

### 12.3 技术实现特点

- Bash 版本：`nohup` + PID 文件 + 信号处理
- Node.js 版本：`child_process.spawn` + Promise 异步流程

### 12.4 扩展新服务（示例）

```bash
start_new_service() {
  cd "$SERVICE_DIR"
  handle_port_conflict $PORT "服务名"
  nohup npm start > "$PROJECT_ROOT/service.log" 2>&1 &
  echo $! > "$SERVICE_PID_FILE"
}
```

## 13. 相关文档

- `/Users/wudao/SuperInbox/cli/README.md`
- `/Users/wudao/SuperInbox/README.md`
- `/Users/wudao/SuperInbox/docs/README.md`
- `/Users/wudao/SuperInbox/docs/api/SuperInbox-Core-API文档.md`
